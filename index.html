<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ¯æ—¥å•è¯è®°å½•æœ¬</title>
<script>
  // æ³¨å†Œ Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then(registration => {
          console.log('ServiceWorker æ³¨å†ŒæˆåŠŸ: ', registration.scope);
        })
        .catch(err => {
          console.log('ServiceWorker æ³¨å†Œå¤±è´¥: ', err);
        });
    });
  }
  
  // æ·»åŠ å®‰è£…æç¤º
  let deferredPrompt;
  
  window.addEventListener('beforeinstallprompt', (e) => {
    // é˜»æ­¢é»˜è®¤çš„å®‰è£…æç¤º
    e.preventDefault();
    // ä¿å­˜äº‹ä»¶ä»¥ä¾¿ç¨åè§¦å‘
    deferredPrompt = e;
    
    // æ˜¾ç¤ºä¸€ä¸ªè‡ªå®šä¹‰çš„å®‰è£…æŒ‰é’®
    const installButton = document.createElement('button');
    installButton.textContent = 'ğŸ“± å®‰è£…åº”ç”¨';
    installButton.style.position = 'fixed';
    installButton.style.bottom = '20px';
    installButton.style.right = '20px';
    installButton.style.padding = '10px 15px';
    installButton.style.backgroundColor = '#6366f1';
    installButton.style.color = 'white';
    installButton.style.border = 'none';
    installButton.style.borderRadius = '5px';
    installButton.style.cursor = 'pointer';
    installButton.style.zIndex = '1000';
    installButton.style.boxShadow = '0 4px 6px rgba(0,0,0,0.1)';
    installButton.style.fontSize = '14px';
    
    installButton.addEventListener('click', () => {
      // éšè—æŒ‰é’®
      installButton.style.display = 'none';
      // æ˜¾ç¤ºå®‰è£…æç¤º
      deferredPrompt.prompt();
      // ç­‰å¾…ç”¨æˆ·å“åº”
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…');
        } else {
          console.log('ç”¨æˆ·å–æ¶ˆäº†å®‰è£…');
        }
        deferredPrompt = null;
      });
    });
    
    document.body.appendChild(installButton);
  });
</script>
<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#6366f1">
<style>
/* åŸºç¡€æ ·å¼é‡ç½® */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Noto Sans SC', sans-serif;
    background-color: #f9fafb;
    color: #1f2937;
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* å®¹å™¨æ ·å¼ */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

@media (min-width: 640px) {
    .container {
        padding: 0 1.5rem;
    }
}

@media (min-width: 1024px) {
    .container {
        padding: 0 2rem;
    }
}

/* ç™»å½•å®¹å™¨ */
.login-container {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    z-index: 1000;
}

.login-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    padding: 2rem;
    width: 100%;
    max-width: 28rem;
    margin: 1rem;
}

/* åº”ç”¨å®¹å™¨ */
.app-container {
    display: none;
    min-height: 100vh;
    background-color: #f9fafb;
}

/* è¡¨å•æ ·å¼ */
.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.25rem;
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 1rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-input:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-textarea {
    resize: vertical;
    min-height: 2.5rem;
}

/* æŒ‰é’®æ ·å¼ */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 1rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 1rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

.btn-primary {
    background-color: #6366f1;
    color: white;
}

.btn-primary:hover {
    background-color: #5558e3;
}

.btn-secondary {
    background-color: #10b981;
    color: white;
}

.btn-secondary:hover {
    background-color: #0ea968;
}

.btn-danger {
    background-color: #ef4444;
    color: white;
}

.btn-danger:hover {
    background-color: #dc2626;
}

.btn-full {
    width: 100%;
}

/* å¡ç‰‡æ ·å¼ */
.card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

/* å•è¯é¡¹æ ·å¼ */
.word-item {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    transition: box-shadow 0.15s ease-in-out;
}

.word-item:hover {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

.word-item.mastered {
    background-color: #f9fafb;
    opacity: 0.7;
}

.word-item.mastered .word-title {
    text-decoration: line-through;
}

.word-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.word-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #4f46e5;
}

.word-actions {
    display: flex;
    gap: 0.5rem;
}

.word-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    font-size: 1.25rem;
    transition: transform 0.15s ease-in-out;
}

.word-btn:hover {
    transform: scale(1.1);
}

.word-detail {
    font-size: 0.875rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
}

.word-detail strong {
    color: #374151;
}

/* ç»Ÿè®¡å¡ç‰‡ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

@media (min-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

.stat-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    padding: 1rem;
    text-align: center;
}

.stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    margin-bottom: 0.25rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
}

/* å¤´éƒ¨æ ·å¼ */
.header {
    background: white;
    border-bottom: 1px solid #e5e7eb;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
}

.user-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.user-name {
    font-weight: 500;
}

.header-actions {
    display: flex;
    gap: 1rem;
}

.header-btn {
    background: none;
    border: none;
    color: #3b82f6;
    cursor: pointer;
    font-size: 0.875rem;
    text-decoration: none;
}

.header-btn:hover {
    color: #2563eb;
}

.header-btn.danger {
    color: #ef4444;
}

.header-btn.danger:hover {
    color: #dc2626;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal.show {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    padding: 1.5rem;
    width: 100%;
    max-width: 32rem;
    max-height: 80vh;
    overflow-y: auto;
    margin: 1rem;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.modal-title {
    font-size: 1.25rem;
    font-weight: 700;
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #6b7280;
}

.modal-close:hover {
    color: #374151;
}

/* åŠ è½½åŠ¨ç”» */
.loading {
    display: inline-block;
    width: 1.25rem;
    height: 1.25rem;
    border: 2px solid #f3f4f6;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* æç¤ºæ¶ˆæ¯ */
.toast {
    position: fixed;
    top: 1rem;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background-color: #10b981;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.375rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    opacity: 0;
    transition: all 0.3s ease-in-out;
    z-index: 2000;
}

.toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

/* åŒæ­¥çŠ¶æ€ */
.sync-status {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    display: none;
    z-index: 1000;
}

.sync-status.show {
    display: block;
}

/* éšè—ç±» */
.hidden {
    display: none !important;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 640px) {
    .modal-content {
        margin: 0.5rem;
        max-height: 90vh;
    }
    
    .word-header {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .word-actions {
        align-self: flex-end;
    }
}

/* åŠ¨ç”»æ•ˆæœ */
.fade-in {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* æ–‡ä»¶æ‹–æ”¾åŒºåŸŸ */
.file-drop {
    border: 2px dashed #d1d5db;
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

.file-drop:hover {
    border-color: #6366f1;
    background-color: #f9fafb;
}

.file-drop.dragover {
    border-color: #6366f1;
    background-color: #eef2ff;
}

/* é”™è¯¯æ¶ˆæ¯ */
.error-message {
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 0.5rem;
    padding: 0.5rem;
    background-color: #fef2f2;
    border-radius: 0.25rem;
    display: none;
}

.error-message.show {
    display: block;
}

/* è¡¨æ ¼æ ·å¼ */
.table-container {
    max-height: 300px;
    overflow-y: auto;
    margin: 1rem 0;
}

.table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
}

.table th,
.table td {
    border: 1px solid #e5e7eb;
    padding: 0.5rem;
    text-align: left;
}

.table th {
    background-color: #f9fafb;
    position: sticky;
    top: 0;
}

.table tr:nth-child(even) {
    background-color: #f9fafb;
}

.table tr:hover {
    background-color: #f3f4f6;
}
</style>
</head>
<body>
<!-- åŠ è½½é®ç½© -->
<div id="loading-overlay" class="loading-overlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.9); display: flex; justify-content: center; align-items: center; z-index: 9999;">
    <div style="text-align: center;">
        <div class="loading"></div>
        <p style="margin-top: 0.5rem; color: #374151;">æ­£åœ¨åˆå§‹åŒ–åº”ç”¨...</p>
        <p id="loading-status" style="font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem;"></p>
    </div>
</div>

<!-- ç™»å½•ç•Œé¢ -->
<div id="login-container" class="login-container">
    <div class="login-card">
        <h2 style="font-size: 1.5rem; font-weight: 700; text-align: center; margin-bottom: 1.5rem;">ğŸ“š æ¯æ—¥å•è¯è®°å½•æœ¬</h2>
        
        <form id="login-form">
            <div class="form-group">
                <label for="username" class="form-label">ç”¨æˆ·å</label>
                <input type="text" id="username" class="form-input" placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·å" required>
            </div>
            
            <div class="form-group">
                <label for="password" class="form-label">å¯†ç </label>
                <input type="password" id="password" class="form-input" placeholder="è¾“å…¥æ‚¨çš„å¯†ç " required>
            </div>
            
            <div class="form-group">
                <label style="display: flex; align-items: center; font-size: 0.875rem; color: #6b7280;">
                    <input type="checkbox" id="use-local" style="margin-right: 0.5rem;">
                    ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼ˆç¦»çº¿æ¨¡å¼ï¼‰
                </label>
            </div>
            
            <button type="submit" class="btn btn-primary btn-full" id="login-btn">
                <span id="login-text">ç™»å½•</span>
                <div id="login-spinner" class="loading" style="display: none; margin-left: 0.5rem;"></div>
            </button>
            
            <p style="text-align: center; font-size: 0.875rem; color: #6b7280; margin-top: 1rem;">
                é¦–æ¬¡ä½¿ç”¨å°†è‡ªåŠ¨åˆ›å»ºè´¦æˆ·
            </p>
        </form>
    </div>
</div>

<!-- ä¸»åº”ç”¨ç•Œé¢ -->
<div id="app-container" class="app-container">
    <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="user-info">
                    <span>ç”¨æˆ·:</span>
                    <span id="current-user" class="user-name"></span>
                </div>
                <div class="header-actions">
                    <button id="sync-btn" class="header-btn">
                        <div id="sync-spinner" class="loading" style="display: none; margin-right: 0.25rem;"></div>
                        <span id="sync-text">æ‰‹åŠ¨åŒæ­¥</span>
                    </button>
                    <button id="logout-btn" class="header-btn danger">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container" style="padding-top: 1.5rem; padding-bottom: 3rem;">
        <!-- æ ‡é¢˜ -->
        <div style="text-align: center; margin-bottom: 2rem;">
            <h1 style="font-size: 2rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">ğŸ“š æ¯æ—¥å•è¯è®°å½•æœ¬</h1>
            <p style="color: #6b7280;">è®°å½•ä½ çš„æ¯ä¸€ç‚¹è¿›æ­¥</p>
        </div>

        <!-- æ·»åŠ å•è¯è¡¨å• -->
        <section class="card">
            <h2 style="font-size: 1.25rem; font-weight: 600; color: #374151; margin-bottom: 1rem;">æ·»åŠ æ–°å•è¯</h2>
            <form id="word-form">
                <div class="form-group">
                    <label for="word-input" class="form-label">å•è¯</label>
                    <input type="text" id="word-input" class="form-input" placeholder="e.g., serendipity" required>
                </div>
                
                <div class="form-group">
                    <label for="meaning-input" class="form-label">é‡Šä¹‰</label>
                    <textarea id="meaning-input" class="form-input form-textarea" placeholder="e.g., æ„å¤–å‘ç°çå¥‡äº‹ç‰©çš„è¿æ°”ï¼›æœºç¼˜å·§åˆ"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="synonym-input" class="form-label">åŒä¹‰è¯</label>
                    <textarea id="synonym-input" class="form-input form-textarea" placeholder="e.g., fortune, luck, fluke"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="phrase-input" class="form-label">è¯ç»„</label>
                    <textarea id="phrase-input" class="form-input form-textarea" placeholder="e.g., a stroke of serendipity"></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary btn-full">æ·»åŠ å•è¯</button>
            </form>
        </section>

        <!-- å¯¼å…¥å¯¼å‡º -->
        <section style="margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                <button id="export-trigger-btn" class="btn btn-secondary">ğŸ“Š å¯¼å‡ºä¸ºExcel</button>
                <button id="import-trigger-btn" class="btn btn-primary">ğŸ“¥ å¯¼å…¥Excelæ–‡ä»¶</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">æ€»è¯æ±‡é‡</div>
                    <div id="total-words" class="stat-value" style="color: #6366f1;">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å­¦ä¹ å¤©æ•°</div>
                    <div id="study-days" class="stat-value" style="color: #10b981;">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">ä»Šæ—¥æ–°è¯</div>
                    <div id="today-words" class="stat-value" style="color: #3b82f6;">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å·²æŒæ¡</div>
                    <div id="mastered-words" class="stat-value" style="color: #8b5cf6;">0</div>
                </div>
            </div>
        </section>

        <!-- å•è¯åˆ—è¡¨ -->
        <section id="word-list-container">
            <!-- å•è¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ -->
        </section>
    </div>
</div>

<!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
<div id="export-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">é€‰æ‹©å¯¼å‡ºæ—¥æœŸ</h3>
            <button class="modal-close" id="close-modal-btn">&times;</button>
        </div>
        <div id="export-options">
            <!-- é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- å¯¼å…¥æ¨¡æ€æ¡† -->
<div id="import-modal" class="modal">
    <div class="modal-content" style="max-width: 42rem;">
        <div class="modal-header">
            <h3 class="modal-title">å¯¼å…¥Excelæ–‡ä»¶</h3>
            <button class="modal-close" id="close-import-modal-btn">&times;</button>
        </div>
        
        <div class="file-drop" id="file-drop-zone">
            <input type="file" id="import-file-input" accept=".xlsx,.xls" style="display: none;">
            <div style="color: #6b7280;">
                <svg style="width: 3rem; height: 3rem; margin: 0 auto 0.75rem; color: #9ca3af;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                </svg>
                <p style="font-size: 0.875rem;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„</p>
                <p style="font-size: 0.75rem; color: #9ca3af; margin-top: 0.25rem;">æ”¯æŒ .xlsx å’Œ .xls æ ¼å¼</p>
            </div>
        </div>
        
        <div id="import-error" class="error-message"></div>
        
        <div style="margin-bottom: 1rem;">
            <h4 style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">å¯¼å…¥é€‰é¡¹</h4>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                    <input type="radio" name="import-option" value="merge" checked style="margin-right: 0.5rem;">
                    åˆå¹¶å¯¼å…¥ï¼ˆä¿ç•™ç°æœ‰æ•°æ®ï¼Œè·³è¿‡é‡å¤å•è¯ï¼‰
                </label>
                <label style="display: flex; align-items: center; font-size: 0.875rem;">
                    <input type="radio" name="import-option" value="replace" style="margin-right: 0.5rem;">
                    æ›¿æ¢å¯¼å…¥ï¼ˆåˆ é™¤ç°æœ‰æ•°æ®ï¼Œå®Œå…¨æ›¿æ¢ï¼‰
                </label>
            </div>
        </div>
        
        <div id="import-preview" style="display: none;">
            <h4 style="font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">æ•°æ®é¢„è§ˆ</h4>
            <div class="table-container">
                <table class="table" id="preview-table">
                    <!-- é¢„è§ˆæ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </table>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                <p id="import-summary" style="font-size: 0.875rem; color: #6b7280;"></p>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="cancel-import-btn" class="btn" style="background-color: #e5e7eb; color: #374151;">å–æ¶ˆ</button>
                    <button id="confirm-import-btn" class="btn btn-primary">ç¡®è®¤å¯¼å…¥</button>
                </div>
            </div>
        </div>
        
        <div id="import-status" style="display: none; text-align: center; padding: 1rem;">
            <div class="loading" style="margin: 0 auto 0.5rem;"></div>
            <p style="font-size: 0.875rem; color: #6b7280;">æ­£åœ¨å¯¼å…¥æ•°æ®...</p>
        </div>
    </div>
</div>

<!-- æç¤ºæ¶ˆæ¯ -->
<div id="encouragement-toast" class="toast">
    <span id="encouragement-text"></span>
</div>

<!-- åŒæ­¥çŠ¶æ€ -->
<div id="sync-status" class="sync-status">
    <span id="sync-status-text">åŒæ­¥ä¸­...</span>
</div>

<script>
// Firebase é…ç½®
const firebaseConfig = {
    apiKey: "AIzaSyBPLuMktx7vBuqmh6KzIyRlNHK4yh4j5OY",
    authDomain: "words-43d1b.firebaseapp.com",
    databaseURL: "https://words-43d1b-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "words-43d1b",
    storageBucket: "words-43d1b.firebasestorage.app",
    messagingSenderId: "992209854334",
    appId: "1:992209854334:web:e862a34544b49a243e1d2f",
    measurementId: "G-982EDQG7X0"
};

// åº”ç”¨çŠ¶æ€
let database = null;
let firebaseAvailable = false;
let currentUser = null;
let wordsData = {};
let isOnline = navigator.onLine;
let useLocalMode = false;
let importData = null;

// åŠ è½½çŠ¶æ€ç®¡ç†
const loadingOverlay = document.getElementById('loading-overlay');
const loadingStatus = document.getElementById('loading-status');

function showLoading(message) {
    if (loadingStatus) {
        loadingStatus.textContent = message;
    }
}

function hideLoading() {
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}

// Firebase SDK åŠ è½½å™¨
class FirebaseLoader {
    async loadFirebaseSDK() {
        showLoading('æ­£åœ¨åŠ è½½ Firebase SDK...');

        try {
            // è®¾ç½®è¶…æ—¶
            const timeoutPromise = new Promise((_, reject) => {
                setTimeout(() => reject(new Error('åŠ è½½è¶…æ—¶')), 10000);
            });

            // å°è¯•åŠ è½½ Firebase
            await Promise.race([
                this.loadScript('https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js'),
                timeoutPromise
            ]);

            await this.loadScript('https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js');
            await this.loadScript('https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js');

            // ç­‰å¾…è„šæœ¬æ‰§è¡Œ
            await this.delay(1000);

            if (typeof firebase !== 'undefined') {
                showLoading('âœ… Firebase SDK åŠ è½½æˆåŠŸï¼');
                await this.delay(500);
                hideLoading();
                return true;
            } else {
                throw new Error('Firebase æœªæ­£ç¡®åŠ è½½');
            }
        } catch (error) {
            console.error('Firebase åŠ è½½å¤±è´¥:', error);
            showLoading('âš ï¸ Firebase åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ¨¡å¼');
            await this.delay(2000);
            hideLoading();
            return false;
        }
    }

    loadScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.async = true;

            script.onload = resolve;
            script.onerror = reject;

            document.head.appendChild(script);
        });
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// åˆå§‹åŒ– Firebase åŠ è½½å™¨
const firebaseLoader = new FirebaseLoader();

// é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹åŠ è½½ Firebase
window.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨');
    
    // è®¾ç½®ä¸€ä¸ªæ€»è¶…æ—¶ï¼Œç¡®ä¿åº”ç”¨ä¸ä¼šä¸€ç›´å¡åœ¨åˆå§‹åŒ–çŠ¶æ€
    const initTimeout = setTimeout(() => {
        console.log('åˆå§‹åŒ–è¶…æ—¶ï¼Œå¼ºåˆ¶éšè—åŠ è½½ç•Œé¢');
        hideLoading();
        initializeApp(true); // å¼ºåˆ¶ä½¿ç”¨æœ¬åœ°æ¨¡å¼
    }, 15000); // 15ç§’è¶…æ—¶
    
    try {
        const firebaseLoaded = await firebaseLoader.loadFirebaseSDK();
        clearTimeout(initTimeout);
        console.log('åˆå§‹åŒ–åº”ç”¨ï¼ŒFirebase å¯ç”¨:', firebaseLoaded);
        initializeApp(!firebaseLoaded);
    } catch (error) {
        clearTimeout(initTimeout);
        console.error('åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™:', error);
        hideLoading();
        initializeApp(true); // å‡ºé”™æ—¶ä½¿ç”¨æœ¬åœ°æ¨¡å¼
    }
});

function initializeApp(firebaseOnly = false) {
    // ç¡®ä¿åŠ è½½é®ç½©è¢«éšè—
    hideLoading();
    
    // åˆå§‹åŒ– Firebase
    if (!firebaseOnly && typeof firebase !== 'undefined') {
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            firebaseAvailable = true;
            console.log('Firebase åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('Firebase åˆå§‹åŒ–å¤±è´¥:', error);
        }
    } else {
        console.log('Firebase ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ¨¡å¼');
    }

    // ç¡®ä¿ç™»å½•ç•Œé¢å¯è§
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    
    if (loginContainer) {
        loginContainer.style.display = 'flex';
    }
    
    if (appContainer) {
        appContainer.style.display = 'none';
    }

    // å¦‚æœ Firebase ä¸å¯ç”¨ï¼Œé»˜è®¤ä½¿ç”¨æœ¬åœ°æ¨¡å¼
    if (!firebaseAvailable) {
        const useLocalCheckbox = document.getElementById('use-local');
        if (useLocalCheckbox) {
            useLocalCheckbox.checked = true;
            useLocalCheckbox.disabled = true;
        }
        useLocalMode = true;
    }

    // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
    initializeEventListeners();
}

function initializeEventListeners() {
    // ç™»å½•è¡¨å•
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
    }

    // é€€å‡ºç™»å½•
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleLogout);
    }

    // æ‰‹åŠ¨åŒæ­¥
    const syncBtn = document.getElementById('sync-btn');
    if (syncBtn) {
        syncBtn.addEventListener('click', handleSync);
    }

    // å•è¯è¡¨å•
    const wordForm = document.getElementById('word-form');
    if (wordForm) {
        wordForm.addEventListener('submit', handleAddWord);
    }

    // å¯¼å…¥å¯¼å‡º
    const exportTriggerBtn = document.getElementById('export-trigger-btn');
    if (exportTriggerBtn) {
        exportTriggerBtn.addEventListener('click', showExportModal);
    }

    const importTriggerBtn = document.getElementById('import-trigger-btn');
    if (importTriggerBtn) {
        importTriggerBtn.addEventListener('click', showImportModal);
    }

    // æ¨¡æ€æ¡†å…³é—­
    const closeModalBtn = document.getElementById('close-modal-btn');
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', hideExportModal);
    }

    const closeImportModalBtn = document.getElementById('close-import-modal-btn');
    if (closeImportModalBtn) {
        closeImportModalBtn.addEventListener('click', hideImportModal);
    }

    const cancelImportBtn = document.getElementById('cancel-import-btn');
    if (cancelImportBtn) {
        cancelImportBtn.addEventListener('click', hideImportModal);
    }

    const confirmImportBtn = document.getElementById('confirm-import-btn');
    if (confirmImportBtn) {
        confirmImportBtn.addEventListener('click', handleImport);
    }

    // æ–‡ä»¶æ‹–æ”¾
    initializeFileDrop();

    // ESC é”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            hideExportModal();
            hideImportModal();
        }
    });

    // ç½‘ç»œçŠ¶æ€ç›‘å¬
    window.addEventListener('online', () => {
        isOnline = true;
        showSyncStatus('ç½‘ç»œå·²è¿æ¥', 2000);
    });

    window.addEventListener('offline', () => {
        isOnline = false;
        showSyncStatus('ç½‘ç»œå·²æ–­å¼€', 2000);
    });
}

// ç™»å½•å¤„ç†
async function handleLogin(e) {
    e.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const useLocalCheckbox = document.getElementById('use-local');
    
    useLocalMode = useLocalCheckbox.checked || !firebaseAvailable;

    if (!username || !password) {
        alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
        return;
    }

    const hashedPassword = hashPassword(password);

    try {
        const loginText = document.getElementById('login-text');
        const loginSpinner = document.getElementById('login-spinner');
        const loginBtn = document.getElementById('login-btn');

        if (loginText) loginText.style.display = 'none';
        if (loginSpinner) loginSpinner.style.display = 'inline-block';
        if (loginBtn) loginBtn.disabled = true;

        showSyncStatus('ç™»å½•ä¸­...');
        console.log(`å°è¯•ç™»å½•ç”¨æˆ·: ${username}, ä½¿ç”¨æœ¬åœ°æ¨¡å¼: ${useLocalMode}`);

        if (useLocalMode) {
            // æœ¬åœ°å­˜å‚¨æ¨¡å¼
            currentUser = username;
            wordsData = JSON.parse(localStorage.getItem('words_' + username) || '{}');
            console.log('æœ¬åœ°å­˜å‚¨æ¨¡å¼ç™»å½•æˆåŠŸ');
            showApp();
        } else {
            // äº‘ç«¯æ¨¡å¼
            if (!database) {
                throw new Error('Firebase æœªåˆå§‹åŒ–');
            }

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
            const userRef = database.ref('users/' + username);
            const snapshot = await userRef.once('value');

            if (snapshot.exists()) {
                // ç”¨æˆ·å­˜åœ¨ï¼ŒéªŒè¯å¯†ç 
                const userData = snapshot.val();
                if (userData.password === hashedPassword) {
                    currentUser = username;
                    await loadUserWords();
                    showApp();
                } else {
                    alert('å¯†ç é”™è¯¯');
                }
            } else {
                // æ–°ç”¨æˆ·ï¼Œåˆ›å»ºè´¦æˆ·
                await userRef.set({
                    password: hashedPassword,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
                currentUser = username;
                wordsData = {};
                showApp();
            }
        }
    } catch (error) {
        console.error('ç™»å½•é”™è¯¯:', error);

        // å¦‚æœäº‘ç«¯å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼
        if (!useLocalMode) {
            const useLocalFallback = confirm(
                `äº‘ç«¯ç™»å½•å¤±è´¥: ${error.message}\n\næ˜¯å¦ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼Ÿ\nï¼ˆæ•°æ®å°†ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œæ— æ³•è·¨è®¾å¤‡åŒæ­¥ï¼‰`
            );

            if (useLocalFallback) {
                useLocalMode = true;
                const useLocalCheckbox = document.getElementById('use-local');
                if (useLocalCheckbox) {
                    useLocalCheckbox.checked = true;
                }
                currentUser = username;
                wordsData = JSON.parse(localStorage.getItem('words_' + username) || '{}');
                showApp();
            } else {
                alert('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        } else {
            alert('ç™»å½•å¤±è´¥: ' + error.message);
        }
    } finally {
        const loginText = document.getElementById('login-text');
        const loginSpinner = document.getElementById('login-spinner');
        const loginBtn = document.getElementById('login-btn');

        if (loginText) loginText.style.display = 'inline';
        if (loginSpinner) loginSpinner.style.display = 'none';
        if (loginBtn) loginBtn.disabled = false;
        showSyncStatus('');
    }
}

// é€€å‡ºç™»å½•
function handleLogout() {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        currentUser = null;
        wordsData = {};
        
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const useLocalCheckbox = document.getElementById('use-local');
        
        if (loginContainer) loginContainer.style.display = 'flex';
        if (appContainer) appContainer.style.display = 'none';
        if (usernameInput) usernameInput.value = '';
        if (passwordInput) passwordInput.value = '';
        if (useLocalCheckbox) useLocalCheckbox.checked = false;
    }
}

// æ‰‹åŠ¨åŒæ­¥
async function handleSync() {
    if (useLocalMode || !firebaseAvailable) {
        showSyncStatus('æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼Œæ— éœ€åŒæ­¥', 2000);
        return;
    }

    if (!isOnline) {
        showSyncStatus('ç½‘ç»œæœªè¿æ¥', 2000);
        return;
    }
    await saveUserWords();
}

// æ·»åŠ å•è¯
async function handleAddWord(e) {
    e.preventDefault();
    
    const wordInput = document.getElementById('word-input');
    const meaningInput = document.getElementById('meaning-input');
    const synonymInput = document.getElementById('synonym-input');
    const phraseInput = document.getElementById('phrase-input');
    const wordForm = document.getElementById('word-form');
    
    const wordText = wordInput.value.trim();
    const meaningText = meaningInput.value.trim();
    const synonymText = synonymInput.value.trim();
    const phraseText = phraseInput.value.trim();

    if (!wordText) return;

    const today = new Date().toISOString().split('T')[0];

    if (!wordsData[today]) {
        wordsData[today] = [];
    }

    const newWord = {
        id: Date.now(),
        word: wordText,
        meaning: meaningText,
        synonym: synonymText,
        phrase: phraseText,
        mastered: false
    };

    wordsData[today].push(newWord);

    // å…ˆæ›´æ–°UIï¼Œå†ä¿å­˜
    if (wordForm) wordForm.reset();
    if (wordInput) wordInput.focus();
    renderWords();
    showRandomEncouragement();

    // ä¿å­˜åˆ°äº‘ç«¯æˆ–æœ¬åœ°
    if (useLocalMode || !firebaseAvailable) {
        localStorage.setItem('words_' + currentUser, JSON.stringify(wordsData));
        showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
    } else {
        if (isOnline) {
            await saveUserWords();
        } else {
            showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
        }
    }
}

// æ˜¾ç¤ºä¸»åº”ç”¨
function showApp() {
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const currentUserSpan = document.getElementById('current-user');
    
    if (loginContainer) loginContainer.style.display = 'none';
    if (appContainer) appContainer.style.display = 'block';
    if (currentUserSpan) {
        currentUserSpan.textContent = currentUser + (useLocalMode || !firebaseAvailable ? ' (æœ¬åœ°æ¨¡å¼)' : '');
    }
    renderWords();
}

// åŠ è½½ç”¨æˆ·æ•°æ®
async function loadUserWords() {
    if (!currentUser) return;

    if (useLocalMode || !firebaseAvailable) {
        wordsData = JSON.parse(localStorage.getItem('words_' + currentUser) || '{}');
        return;
    }

    try {
        showSyncStatus('åŠ è½½æ•°æ®...');
        const wordsRef = database.ref('words/' + currentUser);
        const snapshot = await wordsRef.once('value');
        wordsData = snapshot.val() || {};

        // æ›´æ–°æœ€åç™»å½•æ—¶é—´
        database.ref('users/' + currentUser + '/lastLogin').set(new Date().toISOString());
    } catch (error) {
        console.error('åŠ è½½æ•°æ®é”™è¯¯:', error);
        showSyncStatus('åŠ è½½æ•°æ®å¤±è´¥', 2000);
        wordsData = {};
    }
}

// ä¿å­˜ç”¨æˆ·æ•°æ®
async function saveUserWords() {
    if (!currentUser) return;

    if (useLocalMode || !firebaseAvailable) {
        localStorage.setItem('words_' + currentUser, JSON.stringify(wordsData));
        showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
        return;
    }

    try {
        const syncText = document.getElementById('sync-text');
        const syncSpinner = document.getElementById('sync-spinner');
        
        if (syncText) syncText.style.display = 'none';
        if (syncSpinner) syncSpinner.style.display = 'inline-block';
        showSyncStatus('ä¿å­˜ä¸­...');

        await database.ref('words/' + currentUser).set(wordsData);
        showSyncStatus('å·²åŒæ­¥åˆ°äº‘ç«¯', 1500);
    } catch (error) {
        console.error('ä¿å­˜æ•°æ®é”™è¯¯:', error);
        showSyncStatus('åŒæ­¥å¤±è´¥', 2000);
    } finally {
        const syncText = document.getElementById('sync-text');
        const syncSpinner = document.getElementById('sync-spinner');
        
        if (syncText) syncText.style.display = 'inline';
        if (syncSpinner) syncSpinner.style.display = 'none';
    }
}

// æ¸²æŸ“å•è¯åˆ—è¡¨
function renderWords() {
    const wordListContainer = document.getElementById('word-list-container');
    if (!wordListContainer) return;
    
    wordListContainer.innerHTML = '';
    const sortedDates = Object.keys(wordsData).sort((a, b) => new Date(b) - new Date(a));

    if (sortedDates.length === 0) {
        wordListContainer.innerHTML = '<div class="card"><p style="text-align: center; color: #6b7280;">è¿˜æ²¡æœ‰è®°å½•ä»»ä½•å•è¯ï¼Œå¿«æ¥æ·»åŠ ç¬¬ä¸€ä¸ªå§ï¼</p></div>';
        updateStats();
        return;
    }

    sortedDates.forEach(dateStr => {
        // å¯¹æ¯ä¸€å¤©çš„å•è¯æŒ‰ç…§idå€’åºæ’åˆ—ï¼Œè¿™æ ·æœ€æ–°æ·»åŠ çš„å•è¯ä¼šæ˜¾ç¤ºåœ¨æœ€ä¸Šé¢
        const dayWords = [...wordsData[dateStr]].sort((a, b) => b.id - a.id);
        const dateObj = new Date(dateStr + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

        const daySection = document.createElement('div');
        daySection.className = 'card fade-in';

        const dateHeader = document.createElement('h3');
        dateHeader.style.cssText = 'font-size: 1.125rem; font-weight: 600; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem;';
        dateHeader.textContent = `${formattedDate} (${dayWords.length} ä¸ªå•è¯)`;
        daySection.appendChild(dateHeader);

        dayWords.forEach(word => {
            const wordItem = createWordItem(word, dateStr);
            daySection.appendChild(wordItem);
        });

        wordListContainer.appendChild(daySection);
    });

    updateStats();
}

// åˆ›å»ºå•è¯é¡¹
function createWordItem(word, dateStr) {
    const wordItem = document.createElement('div');
    wordItem.className = `word-item ${word.mastered ? 'mastered' : ''}`;
    wordItem.dataset.date = dateStr;
    wordItem.dataset.id = word.id;

    const wordHeaderDiv = document.createElement('div');
    wordHeaderDiv.className = 'word-header';

    const wordTitle = document.createElement('h4');
    wordTitle.className = 'word-title';
    wordTitle.textContent = word.word;

    const actionButtons = document.createElement('div');
    actionButtons.className = 'word-actions';

    const masterBtn = document.createElement('button');
    masterBtn.className = 'word-btn';
    masterBtn.innerHTML = word.mastered ? 'â†©ï¸' : 'âœ…';
    masterBtn.title = word.mastered ? 'æ ‡è®°ä¸ºæœªæŒæ¡' : 'æ ‡è®°ä¸ºå·²æŒæ¡';
    masterBtn.onclick = () => toggleMaster(dateStr, word.id);

    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'word-btn';
    deleteBtn.innerHTML = 'ğŸ—‘ï¸';
    deleteBtn.title = 'åˆ é™¤';
    deleteBtn.onclick = () => deleteWord(dateStr, word.id);

    actionButtons.appendChild(masterBtn);
    actionButtons.appendChild(deleteBtn);
    wordHeaderDiv.appendChild(wordTitle);
    wordHeaderDiv.appendChild(actionButtons);
    wordItem.appendChild(wordHeaderDiv);

    if (word.meaning) {
        const meaningP = document.createElement('p');
        meaningP.className = 'word-detail';
        meaningP.innerHTML = `<strong>é‡Šä¹‰:</strong> ${word.meaning}`;
        wordItem.appendChild(meaningP);
    }

    if (word.synonym) {
        const synonymP = document.createElement('p');
        synonymP.className = 'word-detail';
        synonymP.innerHTML = `<strong>åŒä¹‰è¯:</strong> ${word.synonym}`;
        wordItem.appendChild(synonymP);
    }

    if (word.phrase) {
        const phraseP = document.createElement('p');
        phraseP.className = 'word-detail';
        phraseP.innerHTML = `<strong>è¯ç»„:</strong> ${word.phrase}`;
        wordItem.appendChild(phraseP);
    }

    return wordItem;
}

// æ›´æ–°ç»Ÿè®¡
function updateStats() {
    let totalWords = 0;
    let masteredWords = 0;
    const today = new Date().toISOString().split('T')[0];
    let todayWordsCount = 0;

    const dates = Object.keys(wordsData);
    dates.forEach(date => {
        const dayWords = wordsData[date];
        totalWords += dayWords.length;
        dayWords.forEach(w => { if (w.mastered) masteredWords++; });
        if (date === today) {
            todayWordsCount = dayWords.length;
        }
    });

    const totalWordsEl = document.getElementById('total-words');
    const studyDaysEl = document.getElementById('study-days');
    const todayWordsEl = document.getElementById('today-words');
    const masteredWordsEl = document.getElementById('mastered-words');

    if (totalWordsEl) totalWordsEl.textContent = totalWords;
    if (studyDaysEl) studyDaysEl.textContent = dates.length;
    if (todayWordsEl) todayWordsEl.textContent = todayWordsCount;
    if (masteredWordsEl) masteredWordsEl.textContent = masteredWords;
}

// åˆ é™¤å•è¯
async function deleteWord(date, id) {
    const idStr = String(id);
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•è¯å—ï¼Ÿ')) {
        wordsData[date] = wordsData[date].filter(w => String(w.id) !== idStr);
        if (wordsData[date].length === 0) {
            delete wordsData[date];
        }
        renderWords();

        if (useLocalMode || !firebaseAvailable) {
            localStorage.setItem('words_' + currentUser, JSON.stringify(wordsData));
            showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
        } else {
            if (isOnline) {
                await saveUserWords();
            } else {
                showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
            }
        }
    }
}

// åˆ‡æ¢æŒæ¡çŠ¶æ€
async function toggleMaster(date, id) {
    const idStr = String(id);
    const word = wordsData[date].find(w => String(w.id) === idStr);
    if (word) {
        word.mastered = !word.mastered;
        renderWords();

        if (useLocalMode || !firebaseAvailable) {
            localStorage.setItem('words_' + currentUser, JSON.stringify(wordsData));
            showSyncStatus('å·²ä¿å­˜åˆ°æœ¬åœ°', 1500);
        } else {
            if (isOnline) {
                await saveUserWords();
            } else {
                showSyncStatus('ç¦»çº¿æ¨¡å¼ï¼Œæ•°æ®å°†åœ¨ç½‘ç»œæ¢å¤ååŒæ­¥', 3000);
            }
        }
    }
}

// æ˜¾ç¤ºéšæœºé¼“åŠ±
function showRandomEncouragement() {
    const encouragements = [
        "å¤ªæ£’äº†ï¼åˆæŒæ¡ä¸€ä¸ªæ–°å•è¯ï¼",
        "åšæŒå°±æ˜¯èƒœåˆ©ï¼",
        "ä½ çš„è¯æ±‡é‡æ­£åœ¨ç¨³æ­¥å¢é•¿ï¼",
        "Excellent! Keep it up!",
        "çŸ¥è¯†å°±æ˜¯åŠ›é‡ï¼Œä½ æ­£åœ¨å˜å¼ºï¼",
        "ä»Šå¤©çš„ä½ æ¯”æ˜¨å¤©æ›´åšå­¦äº†ï¼",
        "Amazing! æ¯ä¸€ä¸ªå•è¯éƒ½æ˜¯ä¸€å—åŸºçŸ³ã€‚",
        "æŒä¹‹ä»¥æ’ï¼Œç»ˆå°†å¤§æˆï¼",
        "ä½ çš„åŠªåŠ›ï¼Œæ—¶é—´çœ‹å¾—è§ï¼",
        "åˆå‘ç›®æ ‡è¿ˆè¿›äº†ä¸€æ­¥ï¼"
    ];

    const toast = document.getElementById('encouragement-toast');
    const encouragementText = document.getElementById('encouragement-text');
    
    if (toast && encouragementText) {
        const randomIndex = Math.floor(Math.random() * encouragements.length);
        const message = encouragements[randomIndex];
        encouragementText.textContent = message;

        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
}

// æ˜¾ç¤ºåŒæ­¥çŠ¶æ€
function showSyncStatus(message, duration = 2000) {
    const syncStatus = document.getElementById('sync-status');
    const syncStatusText = document.getElementById('sync-status-text');
    
    if (syncStatus && syncStatusText) {
        syncStatusText.textContent = message;
        syncStatus.classList.add('show');
        setTimeout(() => {
            syncStatus.classList.remove('show');
        }, duration);
    }
}

// å¯†ç å“ˆå¸Œ
function hashPassword(password) {
    let hash = 0;
    for (let i = 0; i < password.length; i++) {
        const char = password.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return hash.toString();
}

// å¯¼å‡ºç›¸å…³å‡½æ•°
function showExportModal() {
    const modal = document.getElementById('export-modal');
    const exportOptions = document.getElementById('export-options');
    
    if (!modal || !exportOptions) return;
    
    const dates = Object.keys(wordsData).sort((a, b) => new Date(b) - new Date(a));
    exportOptions.innerHTML = '';

    if (dates.length === 0) {
        exportOptions.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 1rem;">æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®ã€‚</p>';
    } else {
        const exportAllBtn = document.createElement('button');
        exportAllBtn.textContent = 'ğŸ“¦ å¯¼å‡ºå…¨éƒ¨æ•°æ®';
        exportAllBtn.className = 'btn btn-secondary';
        exportAllBtn.style.cssText = 'width: 100%; margin-bottom: 0.5rem; justify-content: flex-start;';
        exportAllBtn.onclick = exportAllData;
        exportOptions.appendChild(exportAllBtn);

        dates.forEach(dateStr => {
            const dayWords = wordsData[dateStr];
            const dateObj = new Date(dateStr + 'T00:00:00');
            const formattedDate = dateObj.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });

            const dateBtn = document.createElement('button');
            dateBtn.textContent = `${formattedDate} (${dayWords.length} ä¸ªå•è¯)`;
            dateBtn.className = 'btn';
            dateBtn.style.cssText = 'width: 100%; margin-bottom: 0.5rem; justify-content: flex-start; background-color: #f3f4f6; color: #374151;';
            dateBtn.onclick = () => exportDataForDate(dateStr, formattedDate);
            exportOptions.appendChild(dateBtn);
        });
    }

    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function hideExportModal() {
    const modal = document.getElementById('export-modal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
    }
}

function exportDataForDate(dateStr, formattedDate) {
    const wordsForDate = wordsData[dateStr] || [];
    const allWords = [];

    wordsForDate.forEach(word => {
        allWords.push({
            'æ—¥æœŸ': dateStr,
            'å•è¯': word.word,
            'é‡Šä¹‰': word.meaning || '',
            'åŒä¹‰è¯': word.synonym || '',
            'è¯ç»„': word.phrase || '',
            'æŒæ¡çŠ¶æ€': word.mastered ? 'å·²æŒæ¡' : 'å­¦ä¹ ä¸­'
        });
    });

    if (allWords.length === 0) {
        alert('è¯¥æ—¥æœŸæ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
        return;
    }

    // åˆ›å»ºå¹¶ä¸‹è½½Excelæ–‡ä»¶
    createAndDownloadExcel(allWords, `å•è¯è®°å½•_${dateStr}.xlsx`);
    hideExportModal();
}

function exportAllData() {
    const allWords = [];

    for (const date in wordsData) {
        wordsData[date].forEach(word => {
            allWords.push({
                'æ—¥æœŸ': date,
                'å•è¯': word.word,
                'é‡Šä¹‰': word.meaning || '',
                'åŒä¹‰è¯': word.synonym || '',
                'è¯ç»„': word.phrase || '',
                'æŒæ¡çŠ¶æ€': word.mastered ? 'å·²æŒæ¡' : 'å­¦ä¹ ä¸­'
            });
        });
    }

    if (allWords.length === 0) {
        alert('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡ºï¼');
        return;
    }

    const today = new Date().toISOString().split('T')[0];
    createAndDownloadExcel(allWords, `æˆ‘çš„å•è¯è®°å½•_å…¨éƒ¨_${today}.xlsx`);
    hideExportModal();
}

// å¯¼å…¥ç›¸å…³å‡½æ•°
function showImportModal() {
    const modal = document.getElementById('import-modal');
    if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        resetImportModal();
    }
}

function hideImportModal() {
    const modal = document.getElementById('import-modal');
    if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = '';
        resetImportModal();
    }
}

function resetImportModal() {
    const importFileInput = document.getElementById('import-file-input');
    const importPreview = document.getElementById('import-preview');
    const importStatus = document.getElementById('import-status');
    const importError = document.getElementById('import-error');
    const previewTable = document.getElementById('preview-table');
    
    if (importFileInput) importFileInput.value = '';
    if (importPreview) importPreview.style.display = 'none';
    if (importStatus) importStatus.style.display = 'none';
    if (importError) importError.classList.remove('show');
    if (previewTable) previewTable.innerHTML = '';
    importData = null;
}

function initializeFileDrop() {
    const fileDropZone = document.getElementById('file-drop-zone');
    const importFileInput = document.getElementById('import-file-input');
    
    if (!fileDropZone || !importFileInput) return;

    fileDropZone.addEventListener('click', () => {
        importFileInput.click();
    });

    fileDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileDropZone.classList.add('dragover');
    });

    fileDropZone.addEventListener('dragleave', () => {
        fileDropZone.classList.remove('dragover');
    });

    fileDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        fileDropZone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    importFileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });
}

function handleFileSelect(file) {
    const importError = document.getElementById('import-error');
    const importStatus = document.getElementById('import-status');
    
    // é‡ç½®é”™è¯¯ä¿¡æ¯
    if (importError) importError.classList.remove('show');

    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    if (!file.name.match(/\.(xlsx|xls)$/)) {
        if (importError) {
            importError.textContent = 'è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼ˆ.xlsx æˆ– .xlsï¼‰';
            importError.classList.add('show');
        }
        return;
    }

    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º10MBï¼‰
    if (file.size > 10 * 1024 * 1024) {
        if (importError) {
            importError.textContent = 'æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼ˆ10MBï¼‰';
            importError.classList.add('show');
        }
        return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    if (importStatus) {
        importStatus.style.display = 'block';
        importStatus.innerHTML = '<div class="loading" style="margin: 0 auto 0.5rem;"></div><p style="font-size: 0.875rem; color: #6b7280;">æ­£åœ¨è¯»å–æ–‡ä»¶...</p>';
    }

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);

            // æ£€æŸ¥XLSXåº“æ˜¯å¦å·²åŠ è½½
            if (typeof XLSX === 'undefined') {
                // åŠ¨æ€åŠ è½½XLSXåº“
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                script.onload = function() {
                    // åº“åŠ è½½å®Œæˆåå¤„ç†Excelæ–‡ä»¶
                    processExcelData(data);
                };
                script.onerror = function() {
                    if (importStatus) importStatus.style.display = 'none';
                    if (importError) {
                        importError.textContent = 'æ— æ³•åŠ è½½Excelå¤„ç†åº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                        importError.classList.add('show');
                    }
                };
                document.head.appendChild(script);
            } else {
                // åº“å·²åŠ è½½ï¼Œç›´æ¥å¤„ç†Excelæ–‡ä»¶
                processExcelData(data);
            }
        } catch (error) {
            console.error('è¯»å–æ–‡ä»¶é”™è¯¯:', error);
            if (importStatus) importStatus.style.display = 'none';
            if (importError) {
                importError.textContent = 'è¯»å–æ–‡ä»¶å¤±è´¥: ' + error.message;
                importError.classList.add('show');
            }
        }
    };

    reader.onerror = function() {
        if (importStatus) importStatus.style.display = 'none';
        if (importError) {
            importError.textContent = 'æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•';
            importError.classList.add('show');
        }
    };

    reader.readAsArrayBuffer(file);
}

function processExcelData(data) {
    const importStatus = document.getElementById('import-status');
    const importError = document.getElementById('import-error');
    
    try {
        if (importStatus) {
            importStatus.innerHTML = '<div class="loading" style="margin: 0 auto 0.5rem;"></div><p style="font-size: 0.875rem; color: #6b7280;">æ­£åœ¨è§£æExcelæ–‡ä»¶...</p>';
        }

        const workbook = XLSX.read(data, { type: 'array' });

        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
            throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰å·¥ä½œè¡¨');
        }

        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

        if (jsonData.length === 0) {
            throw new Error('Excelæ–‡ä»¶ä¸­æ²¡æœ‰æ•°æ®');
        }

        // éªŒè¯æ•°æ®æ ¼å¼ - æ›´çµæ´»çš„åˆ—ååŒ¹é…
        const columns = Object.keys(jsonData[0]);
        console.log('Excelåˆ—å:', columns);

        // å°è¯•åŒ¹é…å¿…éœ€çš„åˆ—
        let dateColumn = null;
        let wordColumn = null;

        // æŸ¥æ‰¾æ—¥æœŸåˆ—
        for (const col of columns) {
            if (col.includes('æ—¥æœŸ') || col.toLowerCase().includes('date')) {
                dateColumn = col;
                break;
            }
        }

        // æŸ¥æ‰¾å•è¯åˆ—
        for (const col of columns) {
            if (col.includes('å•è¯') || col.toLowerCase().includes('word')) {
                wordColumn = col;
                break;
            }
        }

        if (!dateColumn || !wordColumn) {
            throw new Error(`Excelæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œå¿…é¡»åŒ…å«"æ—¥æœŸ"å’Œ"å•è¯"åˆ—ã€‚æ‰¾åˆ°çš„åˆ—: ${columns.join(', ')}`);
        }

        // æ ‡å‡†åŒ–æ•°æ®æ ¼å¼
        const standardizedData = jsonData.map(row => {
            const newRow = {};

            // æ ‡å‡†åŒ–æ—¥æœŸåˆ—
            newRow['æ—¥æœŸ'] = row[dateColumn];

            // æ ‡å‡†åŒ–å•è¯åˆ—
            newRow['å•è¯'] = row[wordColumn];

            // æ ‡å‡†åŒ–å…¶ä»–åˆ—
            for (const col of columns) {
                if (col === dateColumn || col === wordColumn) continue;

                if (col.includes('é‡Šä¹‰') || col.toLowerCase().includes('meaning')) {
                    newRow['é‡Šä¹‰'] = row[col];
                } else if (col.includes('åŒä¹‰è¯') || col.toLowerCase().includes('synonym')) {
                    newRow['åŒä¹‰è¯'] = row[col];
                } else if (col.includes('è¯ç»„') || col.toLowerCase().includes('phrase')) {
                    newRow['è¯ç»„'] = row[col];
                } else if (col.includes('æŒæ¡') || col.toLowerCase().includes('master')) {
                    newRow['æŒæ¡çŠ¶æ€'] = row[col];
                } else {
                    // å¦‚æœåˆ—ä¸åŒ¹é…ä»»ä½•å·²çŸ¥åˆ—ï¼Œä¿ç•™åŸåˆ—å
                    newRow[col] = row[col];
                }
            }

            return newRow;
        });

        importData = standardizedData;
        showImportPreview(standardizedData);
        if (importStatus) importStatus.style.display = 'none';
    } catch (error) {
        console.error('å¤„ç†Excelæ•°æ®é”™è¯¯:', error);
        if (importStatus) importStatus.style.display = 'none';
        if (importError) {
            importError.textContent = 'è§£æExcelæ–‡ä»¶å¤±è´¥: ' + error.message;
            importError.classList.add('show');
        }
    }
}

function showImportPreview(data) {
    const importPreview = document.getElementById('import-preview');
    const previewTable = document.getElementById('preview-table');
    const importSummary = document.getElementById('import-summary');
    
    if (!importPreview || !previewTable || !importSummary) return;

    // åˆ›å»ºé¢„è§ˆè¡¨æ ¼
    let tableHTML = `
        <thead>
            <tr>
                <th>æ—¥æœŸ</th>
                <th>å•è¯</th>
                <th>é‡Šä¹‰</th>
                <th>åŒä¹‰è¯</th>
                <th>è¯ç»„</th>
                <th>æŒæ¡çŠ¶æ€</th>
            </tr>
        </thead>
        <tbody>
    `;

    // åªæ˜¾ç¤ºå‰10è¡Œä½œä¸ºé¢„è§ˆ
    const previewRows = data.slice(0, 10);
    previewRows.forEach(row => {
        tableHTML += `
            <tr>
                <td>${row['æ—¥æœŸ'] || ''}</td>
                <td>${row['å•è¯'] || ''}</td>
                <td>${row['é‡Šä¹‰'] || ''}</td>
                <td>${row['åŒä¹‰è¯'] || ''}</td>
                <td>${row['è¯ç»„'] || ''}</td>
                <td>${row['æŒæ¡çŠ¶æ€'] || ''}</td>
            </tr>
        `;
    });

    tableHTML += '</tbody>';
    previewTable.innerHTML = tableHTML;

    // æ˜¾ç¤ºå¯¼å…¥æ‘˜è¦
    const importOption = document.querySelector('input[name="import-option"]:checked').value;
    let summaryText = `å…± ${data.length} æ¡æ•°æ®`;

    if (importOption === 'merge') {
        // è®¡ç®—å°†å¯¼å…¥çš„æ–°æ•°æ®é‡
        let newWordCount = 0;
        data.forEach(row => {
            const date = row['æ—¥æœŸ'];
            const word = row['å•è¯'];
            if (date && word) {
                if (!wordsData[date] || !wordsData[date].some(w => w.word === word)) {
                    newWordCount++;
                }
            }
        });
        summaryText += `ï¼Œå…¶ä¸­ ${newWordCount} æ¡ä¸ºæ–°æ•°æ®`;
    }

    importSummary.textContent = summaryText;
    importPreview.style.display = 'block';
}

async function handleImport() {
    if (!importData) return;

    const importOption = document.querySelector('input[name="import-option"]:checked').value;
    const importPreview = document.getElementById('import-preview');
    const importStatus = document.getElementById('import-status');
    const importError = document.getElementById('import-error');

    try {
        if (importPreview) importPreview.style.display = 'none';
        if (importStatus) importStatus.style.display = 'block';

        if (importOption === 'replace') {
            wordsData = {};
        }

        // å¤„ç†å¯¼å…¥æ•°æ®
        let importCount = 0;
        let skipCount = 0;

        for (const row of importData) {
            const date = row['æ—¥æœŸ'];
            const word = row['å•è¯'];

            if (!date || !word) continue;

            if (!wordsData[date]) {
                wordsData[date] = [];
            }

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆåˆå¹¶æ¨¡å¼ï¼‰
            if (importOption === 'merge') {
                const exists = wordsData[date].some(w => w.word === word);
                if (exists) {
                    skipCount++;
                    continue;
                }
            }

            // åˆ›å»ºæ–°å•è¯å¯¹è±¡
            const newWord = {
                id: Date.now() + Math.random(),
                word: word,
                meaning: row['é‡Šä¹‰'] || '',
                synonym: row['åŒä¹‰è¯'] || '',
                phrase: row['è¯ç»„'] || '',
                mastered: row['æŒæ¡çŠ¶æ€'] === 'å·²æŒæ¡'
            };

            wordsData[date].push(newWord);
            importCount++;
        }

        // ä¿å­˜åˆ°äº‘ç«¯æˆ–æœ¬åœ°
        await saveUserWords();

        // æ˜¾ç¤ºç»“æœ
        let message = `æˆåŠŸå¯¼å…¥ ${importCount} æ¡æ•°æ®`;
        if (skipCount > 0) {
            message += `ï¼Œè·³è¿‡ ${skipCount} æ¡é‡å¤æ•°æ®`;
        }

        showSyncStatus(message, 3000);

        // åˆ·æ–°æ˜¾ç¤º
        renderWords();

        // å…³é—­æ¨¡æ€æ¡†
        setTimeout(() => {
            hideImportModal();
        }, 1000);

    } catch (error) {
        console.error('å¯¼å…¥æ•°æ®é”™è¯¯:', error);
        if (importError) {
            importError.textContent = 'å¯¼å…¥å¤±è´¥: ' + error.message;
            importError.classList.add('show');
        }
    } finally {
        if (importStatus) importStatus.style.display = 'none';
    }
}

// åˆ›å»ºå¹¶ä¸‹è½½Excelæ–‡ä»¶
function createAndDownloadExcel(data, fileName) {
    // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½XLSXåº“
    if (typeof XLSX === 'undefined') {
        // åŠ¨æ€åŠ è½½XLSXåº“
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
        script.onload = function() {
            // åº“åŠ è½½å®Œæˆååˆ›å»ºExcelæ–‡ä»¶
            createExcelFile(data, fileName);
        };
        script.onerror = function() {
            alert('æ— æ³•åŠ è½½Excelå¯¼å‡ºåº“ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        };
        document.head.appendChild(script);
    } else {
        // åº“å·²åŠ è½½ï¼Œç›´æ¥åˆ›å»ºExcelæ–‡ä»¶
        createExcelFile(data, fileName);
    }
}

// åˆ›å»ºExcelæ–‡ä»¶
function createExcelFile(data, fileName) {
    try {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "å•è¯è®°å½•");
        XLSX.writeFile(wb, fileName);
    } catch (error) {
        console.error('åˆ›å»ºExcelæ–‡ä»¶å¤±è´¥:', error);
        alert('åˆ›å»ºExcelæ–‡ä»¶å¤±è´¥: ' + error.message);
    }
}

console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
</script>
    
</body>

</html>

